{% extends "hotellapp/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center">
    <h2 class="me-3 mb-0">Reservations Calendar</h2>
    <div class="d-none d-md-flex align-items-center small text-muted">
      <span class="badge me-2" style="background:#0d6efd;">&nbsp;</span> Booked
      <span class="badge ms-3 me-2" style="background:#198754;">&nbsp;</span> Checked-in
    </div>
  </div>
  <div class="d-flex align-items-center">
    <a class="btn btn-success me-2" href="{% url 'reservation_add' %}?check_in={{ start|date:'Y-m-d' }}&check_out={{ next_start|date:'Y-m-d' }}">Add reservation</a>
    <form class="d-flex align-items-center" method="get" action="">
      <label class="me-2">Start</label>
      <input type="date" name="start" class="form-control me-2" value="{{ start|date:'Y-m-d' }}">
      <label class="me-2">Days</label>
      <select name="days" class="form-select me-2">
        <option value="7" {% if days == 7 %}selected{% endif %}>7</option>
        <option value="14" {% if days == 14 %}selected{% endif %}>14</option>
        <option value="30" {% if days == 30 %}selected{% endif %}>30</option>
      </select>
      <button class="btn btn-primary">Go</button>
    </form>
  </div>
</div>

<div class="d-flex justify-content-between mb-2">
  <a class="btn btn-outline-secondary" href="?start={{ prev_start|date:'Y-m-d' }}&days={{ days }}">« Prev</a>
  <a class="btn btn-outline-secondary" href="?start={{ next_start|date:'Y-m-d' }}&days={{ days }}">Next »</a>
</div>

<style>
  .calendar-table th, .calendar-table td { text-align: center; vertical-align: middle; }
  .block { border-radius: 999px; padding: 0.35rem 0.6rem; color: #fff; font-weight: 500; display: inline-block; max-width: 100%; }
  .block.booked { background-color: #0d6efd; }      /* primary */
  .block.checked_in { background-color: #198754; }  /* success */
  .block_text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; max-width: 100%; }
  .room-col { width: 220px; text-align: left !important; }
  .cell-empty { background: #f8f9fa; }
  .progress { height: 10px; }
  .progress-bar { font-size: 10px; }
  @media (max-width: 768px) {
    .room-col { width: 140px; }
    .calendar-table th small { display: none; }
    .block { padding: 0.3rem 0.5rem; font-size: 0.9rem; }
  }
  @media (max-width: 576px) {
    .room-col { width: 120px; }
    .block_text { font-size: 0.85rem; }
  }
</style>

<div class="table-responsive">
  <table class="table table-bordered calendar-table">
    <thead class="table-light">
      <tr>
        <th class="room-col">Room</th>
        {% for d in dates %}
          <th>{{ d.d|date:"d" }}<br><small class="text-muted">{{ d.dow }}</small></th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in rooms_data %}
        <tr>
          <th class="room-col">{{ row.room.number }} <small class="text-muted">({{ row.room.get_type_display }})</small></th>
          {% for cell in row.cells %}
            {% if cell.type == 'block' %}
              <td colspan="{{ cell.span }}">
                <div class="d-flex align-items-center justify-content-between gap-2">
                  <a class="text-decoration-none flex-grow-1" href="{% url 'reservation_edit' cell.reservation_id %}">
                    <div class="block {{ cell.status }}" title="Edit reservation">
                      <span class="block_text">#{{ cell.reservation_id }} • {{ cell.label }}</span>
                    </div>
                  </a>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light border" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Change status">
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-0">
                      {% if cell.status == 'booked' %}
                        <form method="post" action="{% url 'reservation_check_in' cell.reservation_id %}">
                          {% csrf_token %}
                          <button class="dropdown-item" type="submit"><i class="bi bi-box-arrow-in-right me-1"></i>Check-in</button>
                        </form>
                        <form method="post" action="{% url 'reservation_cancel' cell.reservation_id %}">
                          {% csrf_token %}
                          <button class="dropdown-item text-warning" type="submit"><i class="bi bi-x-circle me-1"></i>Cancel</button>
                        </form>
                      {% elif cell.status == 'checked_in' %}
                        <form method="post" action="{% url 'reservation_check_out' cell.reservation_id %}">
                          {% csrf_token %}
                          <button class="dropdown-item text-warning" type="submit"><i class="bi bi-box-arrow-right me-1"></i>Check-out</button>
                        </form>
                      {% endif %}
                      <div><a class="dropdown-item" href="{% url 'reservation_edit' cell.reservation_id %}"><i class="bi bi-pencil-square me-1"></i>Edit…</a></div>
                    </div>
                  </div>
                </div>
              </td>
            {% else %}
              <td class="cell-empty" colspan="{{ cell.span }}"></td>
            {% endif %}
          {% endfor %}
        </tr>
      {% empty %}
        <tr><td colspan="{{ dates|length|add:1 }}" class="text-center text-muted">No rooms.</td></tr>
      {% endfor %}
      {% if rooms_data %}
        <tr>
          <th class="room-col">Occupancy</th>
          {% for o in occupancy %}
            <td>
              <div class="progress">
                <div class="progress-bar bg-info" role="progressbar" style="width: {{ o.percent }}%" aria-valuenow="{{ o.percent }}" aria-valuemin="0" aria-valuemax="100">{{ o.percent }}%</div>
              </div>
              <small class="text-muted">{{ o.count }}/{{ rooms_count }}</small>
            </td>
          {% endfor %}
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endblock %}
