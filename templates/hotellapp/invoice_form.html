{% extends "hotellapp/base.html" %}
{% block content %}
<section class="d-flex justify-content-between align-items-center">
  <div>
    <h2 class="mb-0">Edit Invoice {{ invoice.series }}-{{ invoice.number|default:invoice.id }}</h2>
    <div class="text-muted small">Issued on: <span class="badge text-bg-light">{{ invoice.issue_date }}</span></div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'invoice_detail' invoice.pk %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back</a>
  </div>
</section>

<form method="post" novalidate class="mt-3">
  {% csrf_token %}
  {{ form.non_field_errors }}
  <div class="card">
    <div class="card-body">
      <div class="row g-3">
        {% for field in form %}
          <div class="col-md-6">
            <label class="form-label">{{ field.label }}</label>
            {{ field }}
            {% for error in field.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h4 class="mb-0">Items</h4>
      <button type="button" class="btn btn-outline-primary btn-sm" id="add-row"><i class="bi bi-plus-lg"></i> Add item</button>
    </div>
    <div class="card-body">
      {{ formset.management_form }}
      <div class="table-responsive">
        <table class="table table-hover align-middle table-modern">
          <thead class="table-light">
            <tr>
              <th>Description</th>
              <th style="width:120px;" class="text-end">Qty</th>
              <th style="width:160px;" class="text-end">Unit price</th>
              <th style="width:120px;" class="text-end">VAT %</th>
              <th style="width:60px;"></th>
            </tr>
          </thead>
          <tbody id="line-items">
            {% for f in formset.forms %}
              <tr class="line">
                <td>{{ f.description }}</td>
                <td class="text-end">{{ f.quantity }}</td>
                <td class="text-end">{{ f.unit_price }}</td>
                <td class="text-end">{{ f.vat_rate }}</td>
                <td>
                  {% if f.instance.pk %}{{ f.DELETE }} <span class="text-danger small">Delete</span>{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="text-end">
        <button type="submit" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</form>

<!-- Template for empty row -->
<table class="d-none">
  <tbody id="empty-form-prototype">
    <tr class="line">
      <td>__DESC__</td>
      <td class="text-end">__QTY__</td>
      <td class="text-end">__UNIT__</td>
      <td class="text-end">__VAT__</td>
      <td></td>
    </tr>
  </tbody>
</table>

<script>
(function() {
  const addBtn = document.getElementById('add-row');
  const tbody = document.getElementById('line-items');
  const totalForms = document.getElementById('id_' + '{{ formset.prefix }}' + '-TOTAL_FORMS');

  // Build a prototype from empty_form
  function makeProto() {
    const ef = {{ formset.empty_form.as_p|safe|escapejs }};
    // Convert the <p> fields to table cells
    const div = document.createElement('div');
    div.innerHTML = ef;
    const inputs = div.querySelectorAll('input, select, textarea');
    let desc, qty, unit, vat;
    inputs.forEach(inp => {
      if (inp.name.includes('description')) desc = inp.outerHTML;
      if (inp.name.includes('quantity')) qty = inp.outerHTML;
      if (inp.name.includes('unit_price')) unit = inp.outerHTML;
      if (inp.name.includes('vat_rate')) vat = inp.outerHTML;
    });
    const proto = document.getElementById('empty-form-prototype').querySelector('tr').cloneNode(true);
    proto.innerHTML = proto.innerHTML
      .replace('__DESC__', desc || '')
      .replace('__QTY__', qty || '')
      .replace('__UNIT__', unit || '')
      .replace('__VAT__', vat || '');
    return proto;
  }

  const prototypeRow = makeProto();

  addBtn?.addEventListener('click', () => {
    const idx = parseInt(totalForms.value, 10);
    const row = prototypeRow.cloneNode(true);
    // Replace __prefix__ in names/ids
    row.querySelectorAll('input, select, textarea').forEach(el => {
      ['name', 'id'].forEach(attr => {
        if (el[attr]) el[attr] = el[attr].replace('__prefix__', idx);
      });
    });
    tbody.appendChild(row);
    totalForms.value = idx + 1;
  });
})();
</script>
{% endblock %}
