{% extends "hotellapp/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary" href="?start={{ prev_start|date:'Y-m-d' }}&days={{ days }}"><i class="bi bi-arrow-left"></i> Prev</a>
    <a class="btn btn-outline-secondary" href="?start={{ next_start|date:'Y-m-d' }}&days={{ days }}">Next <i class="bi bi-arrow-right"></i></a>
    <div class="btn-group ms-2" role="group" aria-label="Range">
      <a class="btn btn-outline-primary {% if days == 7 %}active{% endif %}" href="?start={{ start|date:'Y-m-d' }}&days=7">7 days</a>
      <a class="btn btn-outline-primary {% if days == 14 %}active{% endif %}" href="?start={{ start|date:'Y-m-d' }}&days=14">14 days</a>
      <a class="btn btn-outline-primary {% if days == 30 %}active{% endif %}" href="?start={{ start|date:'Y-m-d' }}&days=30">30 days</a>
    </div>
  </div>
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-primary" href="{% url 'reservation_add' %}"><i class="bi bi-plus-circle"></i> New Reservation</a>
    <a class="btn btn-primary" href="{% url 'client_add' %}"><i class="bi bi-person-plus"></i> New Client</a>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-start flex-wrap gap-2">
    <div>
      <strong>Calendar</strong> • Starting {{ start|date:"Y-m-d" }}
    </div>
    <div class="text-muted">
      Occupancy today: {{ occupancy.0.percent }}% ({{ occupancy.0.count }}/{{ rooms_count }})
    </div>

    <div class="w-100 d-flex flex-wrap align-items-center gap-2 mt-2">
      <div class="d-flex align-items-center gap-2 small">
        <span class="badge rounded-pill bg-info-subtle text-info border border-info-subtle">Arrivals <span id="arrivalsCount" class="ms-1">0</span></span>
        <span class="badge rounded-pill bg-warning-subtle text-warning border border-warning-subtle">Departures <span id="departuresCount" class="ms-1">0</span></span>
        <span class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">Dirty <span id="dirtyCount" class="ms-1">0</span></span>
      </div>
      <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-primary cal-filter" data-filter="arrival"><i class="bi bi-box-arrow-in-right me-1"></i>Arrivals</button>
        <button type="button" class="btn btn-sm btn-outline-warning cal-filter" data-filter="departure"><i class="bi bi-box-arrow-right me-1"></i>Departures</button>
        <button type="button" class="btn btn-sm btn-outline-danger cal-filter" data-filter="dirty"><i class="bi bi-broom me-1"></i>Dirty</button>
        <button type="button" class="btn btn-sm btn-outline-secondary cal-filter active" data-filter="all"><i class="bi bi-slash-circle me-1"></i>All</button>
      </div>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 calendar-grid align-middle">
        <thead class="table-light">
          <tr>
            <th style="min-width: 160px;">Room</th>
            {% for d in dates %}
              <th class="text-center" data-date="{{ d.d|date:'Y-m-d' }}">
                <div class="small text-muted">{{ d.dow }}</div>
                <div>{{ d.d|date:"M d" }}</div>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in rooms_data %}
            <tr data-room-id="{{ row.room.id }}">
              <th>
                <div class="d-flex justify-content-between">
                  <span>#{{ row.room.number }} ({{ row.room.get_type_display }})</span>
                  <span class="badge bg-secondary">{{ row.room.get_status_display }}</span>
                </div>
              </th>
              {% for cell in row.cells %}
                {% if cell.type == 'empty' %}
                  {% for i in ""|center:cell.span %}
                    <td class="cal-cell cal-empty" data-room-id="{{ row.room.id }}"></td>
                  {% endfor %}
                {% else %}
                  <td class="cal-cell cal-block status-{{ cell.status }}" colspan="{{ cell.span }}"
                      data-reservation-id="{{ cell.reservation_id }}"
                      title="Reservation: {{ cell.label }} ({{ cell.status }})">
                    <div class="text-truncate">
                      <i class="bi bi-person-fill me-1"></i>{{ cell.label }}
                    </div>
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="p-2 small text-muted">
      Tip: Click a room’s empty start date, then click the end date to create a reservation prefilled with that range. Dragging across cells also works.
    </div>
  </div>
</div>

<style>
  .calendar-grid th, .calendar-grid td { white-space: nowrap; color: var(--text-100); }
  .calendar-grid .cal-cell { min-width: 110px; height: 48px; position: relative; transition: background .18s ease, box-shadow .18s ease, transform .12s ease; }

  /* Base cells */
  .calendar-grid .cal-empty {
    cursor: crosshair;
    background: rgba(255,255,255,0.04);
  }
  .calendar-grid .cal-empty:hover {
    background: rgba(255,255,255,0.07);
  }
  .calendar-grid .cal-empty.highlight {
    background: linear-gradient(180deg, rgba(108,123,255,.18), rgba(169,105,255,.18));
    box-shadow: inset 0 0 0 2px rgba(108,123,255,.25);
  }
  /* Selection endpoints */
  .calendar-grid .cal-empty.sel-start {
    background: rgba(16,185,129,0.28); /* check-in: emerald */
    box-shadow: 0 6px 24px rgba(16,185,129,.25), inset 0 0 0 2px rgba(16,185,129,.35);
  }
  .calendar-grid .cal-empty.sel-start::after {
    content: '';
    position: absolute; inset: 6px;
    border-radius: 8px;
    border: 2px solid rgba(16,185,129,.6);
    box-shadow: 0 0 0 0 rgba(16,185,129,.55);
    animation: sel-pulse 1.6s ease-out infinite;
    pointer-events: none;
  }
  .calendar-grid .cal-empty.sel-end {
    background: rgba(59,130,246,0.30); /* check-out: blue */
    box-shadow: 0 6px 24px rgba(59,130,246,.22), inset 0 0 0 2px rgba(59,130,246,.35);
  }
  .calendar-grid .cal-empty.is-pressing { transform: scale(.98); }

  .calendar-grid .cal-block {
    background: rgba(91,108,255,0.22);
    border-left: 3px solid var(--brand-primary);
    color: #fff;
  }

  /* Status colors on dark */
  .status-booked {
    background: rgba(245,158,11,0.22) !important;     /* amber */
    border-left-color: #f59e0b !important;
    color: #fff;
  }
  .status-checked_in {
    background: rgba(22,163,74,0.28) !important;      /* green, a bit stronger */
    border-left-color: #16a34a !important;
    color: #fff;
    box-shadow: inset 0 0 0 2px rgba(22,163,74,.22);
  }

  /* Cleaning state after check-out - animated subtle stripes */
  .calendar-grid .cal-cleaning {
    --stripe: rgba(250,204,21,0.3);
    background:
      repeating-linear-gradient(45deg, var(--stripe) 0 10px, rgba(250,204,21,0.18) 10px 20px);
    animation: clean-sweep 8s linear infinite;
    color: #111827;
    text-align: center;
  }
  .calendar-grid .cal-cleaning .icon { opacity: .9; }

  @keyframes sel-pulse {
    0% { box-shadow: 0 0 0 0 rgba(16,185,129,.55); opacity: 1; }
    70% { box-shadow: 0 0 0 12px rgba(16,185,129,0); opacity: .9; }
    100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); opacity: 1; }
  }
  @keyframes clean-sweep {
    0% { background-position: 0 0; }
    100% { background-position: 200px 0; }
  }

  /* Today column highlight */
  thead th.is-today {
    box-shadow: inset 0 -4px 0 rgba(169,105,255,.85);
  }
  .calendar-grid td.is-today-col {
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.14), inset 0 -4px 0 rgba(169,105,255,.6);
  }

  /* Row-level highlights (subtle, only on empty cells to avoid overpowering reservations) */
  tbody tr.row-arrival td.cal-empty { background: rgba(16,185,129,.08); }
  tbody tr.row-departure td.cal-empty { background: rgba(234,179,8,.08); }
  tbody tr.row-dirty td.cal-empty { background: rgba(239,68,68,.08); }

  /* Left indicator bar on room header */
  tbody tr.row-arrival th,
  tbody tr.row-departure th,
  tbody tr.row-dirty th { position: relative; }
  tbody tr.row-arrival th::before,
  tbody tr.row-departure th::before,
  tbody tr.row-dirty th::before {
    content: '';
    position: absolute; left: 6px; top: 12px; bottom: 12px; width: 4px; border-radius: 2px;
  }
  tbody tr.row-arrival th::before { background: linear-gradient(180deg, rgba(16,185,129,.9), rgba(16,185,129,.5)); }
  tbody tr.row-departure th::before { background: linear-gradient(180deg, rgba(234,179,8,.9), rgba(234,179,8,.5)); }
  tbody tr.row-dirty th::before { background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(239,68,68,.6)); }
</style>

<style>
  /* Sticky header and sticky room column for better navigation */
  .calendar-grid thead th {
    position: sticky;
    top: 0;
    z-index: 9;
    background: rgba(18, 24, 48, 0.92);
    backdrop-filter: blur(10px) saturate(140%);
    border-bottom: 1px solid rgba(255,255,255,.14);
  }
  .calendar-grid tbody th {
    position: sticky;
    left: 0;
    z-index: 8;
    background: rgba(18, 24, 48, 0.9);
    backdrop-filter: blur(8px) saturate(140%);
    border-right: 1px solid rgba(255,255,255,.12);
  }

  /* Weekend styling */
  thead th.is-weekend {
    background: linear-gradient(180deg, rgba(169,105,255,.20), rgba(0,208,255,.10));
  }
  .calendar-grid td.is-weekend-col {
    background: rgba(255,255,255,0.035);
  }
  .calendar-grid td.is-weekend-col.cal-empty:hover {
    background: rgba(255,255,255,0.08);
  }

  /* Refine reservation blocks (gradient, rounded, subtle elevation) */
  .calendar-grid .cal-block {
    border-radius: .6rem;
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.06), 0 10px 28px rgba(0,0,0,.28);
    transition: transform .12s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
  }
  .calendar-grid .cal-block:hover {
    transform: translateY(-1px);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.08), 0 14px 40px rgba(0,0,0,.36);
  }
  .calendar-grid .cal-block.status-booked {
    background: linear-gradient(90deg, rgba(245,158,11,.22), rgba(245,158,11,.32)) !important;
    border-left: 4px solid #f59e0b !important;
  }
  .calendar-grid .cal-block.status-checked_in {
    background: linear-gradient(90deg, rgba(16,185,129,.22), rgba(22,163,74,.32)) !important;
    border-left: 4px solid #16a34a !important;
  }

  /* Softer grid and row hover (without overriding active highlights) */
  .calendar-grid tbody tr:hover td.cal-empty:not(.highlight):not(.sel-start):not(.sel-end) {
    background: rgba(255,255,255,0.06);
  }

  /* Click ripple on empty cells */
  .calendar-grid .cal-empty { overflow: hidden; }
  .calendar-grid .cal-empty:active::after {
    content: '';
    position: absolute;
    left: 50%; top: 50%;
    width: 140%; height: 140%;
    transform: translate(-50%, -50%) scale(0);
    border-radius: 12px;
    background: radial-gradient(circle at center, rgba(169,105,255,.35), rgba(169,105,255,0) 55%);
    animation: ripple .5s ease forwards;
    pointer-events: none;
  }
  @keyframes ripple {
    to { transform: translate(-50%, -50%) scale(1); opacity: 0; }
  }
</style>

<script>
(function() {
  // Build an array of dates for quick lookup from header
  const headerCells = Array.from(document.querySelectorAll('thead th[data-date]'));
  const headerDates = headerCells.map(th => th.dataset.date);

  // Selection state for creating reservation
  let selecting = false;
  let startCell = null;
  let endCell = null;

  function cellDateIndex(td) {
    // Compute this td's starting day index within its row, accounting for colspans
    let acc = 0;
    for (const sib of Array.from(td.parentElement.children).slice(1)) { // skip first header (room)
      const span = parseInt(sib.getAttribute('colspan') || '1', 10);
      if (sib === td) return acc;
      acc += span;
    }
    return -1;
  }

  function getDateByIndex(i) {
    if (i < 0 || i >= headerDates.length) return null;
    return headerDates[i];
  }

  function clearHighlights(row) {
    row.querySelectorAll('.cal-empty.highlight, .cal-empty.sel-start, .cal-empty.sel-end, .cal-empty.is-pressing')
      .forEach(el => el.classList.remove('highlight', 'sel-start', 'sel-end', 'is-pressing'));
  }

  function highlightRange(row, startIdx, endIdx) {
    if (startIdx == null || endIdx == null) return;
    if (endIdx < startIdx) [startIdx, endIdx] = [endIdx, startIdx];
    let cursor = 0;
    for (const td of Array.from(row.children).slice(1)) {
      const span = parseInt(td.getAttribute('colspan') || '1', 10);
      const cellStart = cursor;
      const cellEnd = cursor + span - 1;
      if (td.classList.contains('cal-empty') && cellEnd >= startIdx && cellStart <= endIdx) {
        td.classList.add('highlight');
      }
      cursor += span;
    }
  }

  function beginSelection(td) {
    const row = td.parentElement;
    selecting = true;
    startCell = td;
    endCell = null;
    clearHighlights(row);
    const sIdx = cellDateIndex(td);
    highlightRange(row, sIdx, sIdx);
    // Visual: mark as start and add a quick press animation
    td.classList.add('sel-start', 'is-pressing');
    setTimeout(() => td.classList.remove('is-pressing'), 180);
  }

  function endSelection(td) {
    const row = td.parentElement;
    const roomId = row.getAttribute('data-room-id');
    const startIdx = cellDateIndex(startCell);
    const endIdx = cellDateIndex(td);
    const [a, b] = startIdx <= endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
    const checkIn = getDateByIndex(a);
    const checkOutIdx = b + 1; // end date is exclusive
    const checkOut = getDateByIndex(checkOutIdx);
    if (!checkIn || !checkOut) {
      selecting = false; startCell = null; clearHighlights(row);
      return;
    }
    // Redirect to reservation add with prefilled data
    const url = new URL("{% url 'reservation_add' %}", window.location.origin);
    url.searchParams.set('room', roomId);
    url.searchParams.set('check_in', checkIn);
    url.searchParams.set('check_out', checkOut);
    window.location.href = url.toString();
  }

  // Attach events
  function attachEmptyCellListeners(td) {
    td.addEventListener('mousedown', (e) => {
      e.preventDefault();
      td.classList.add('is-pressing');
      setTimeout(() => td.classList.remove('is-pressing'), 160);
      beginSelection(td);
    });
    td.addEventListener('mouseenter', () => {
      if (!selecting || !startCell) return;
      const row = td.parentElement;
      clearHighlights(row);
      // keep the range and visually mark endpoints
      const sIdx = cellDateIndex(startCell);
      const eIdx = cellDateIndex(td);
      highlightRange(row, sIdx, eIdx);
      startCell.classList.add('sel-start');
      td.classList.add('sel-end');
      endCell = td;
    });
    td.addEventListener('mouseup', () => {
      if (!selecting || !startCell) return;
      endSelection(td);
      selecting = false;
      startCell = null;
      endCell = null;
    });
  }
  document.querySelectorAll('tbody td.cal-empty').forEach(attachEmptyCellListeners);
  // Expose for later dynamic cells
  window._attachEmptyCellListeners = attachEmptyCellListeners;

  document.addEventListener('mouseup', () => {
    selecting = false; startCell = null;
    document.querySelectorAll('tbody tr').forEach(clearHighlights);
  });
})();
</script>

<script>
// Context menu for right-click actions (Check-in, Check-out, Mark room cleaned) with live UI updates
(function() {
  const calendar = document.querySelector('.calendar-grid');
  if (!calendar) return;

  // Create menu element
  const menu = document.createElement('div');
  menu.id = 'cal-ctx-menu';
  menu.style.cssText = 'position:fixed;display:none;min-width:200px;background:rgba(15,23,42,.98);border:1px solid rgba(255,255,255,.12);border-radius:.5rem;box-shadow:0 .5rem 1rem rgba(0,0,0,.35);z-index:1070;overflow:hidden;color:#f8fafc;';
  document.body.appendChild(menu);

  function hideMenu() { menu.style.display = 'none'; menu.innerHTML = ''; }
  function showMenu(x, y, items) {
    if (!items.length) return;
    menu.innerHTML = '';
    items.forEach(({label, onClick}) => {
      const a = document.createElement('a');
      a.href = '#';
      a.textContent = label;
      a.style.cssText = 'display:block;padding:.5rem .75rem;color:#f8fafc;text-decoration:none;';
      a.addEventListener('mouseenter', () => a.style.background = 'rgba(255,255,255,0.08)');
      a.addEventListener('mouseleave', () => a.style.background = '');
      a.addEventListener('click', (e) => { e.preventDefault(); hideMenu(); onClick(); });
      menu.appendChild(a);
    });
    const vw = window.innerWidth, vh = window.innerHeight;
    const rectW = 220, rectH = 40 * items.length;
    const left = Math.min(x, vw - rectW - 8);
    const top = Math.min(y, vh - rectH - 8);
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    menu.style.display = 'block';
  }

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  async function postWithCsrf(url) {
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      // Django returns 302 -> followed; treat any 200-399 as success
      return resp.ok || (resp.status >= 200 && resp.status < 400);
    } catch {
      return false;
    }
  }

  calendar.addEventListener('contextmenu', function(e) {
    const td = e.target.closest('td,th');
    if (!td) return;
    e.preventDefault();

    const tr = td.closest('tr');
    const roomId = tr ? tr.getAttribute('data-room-id') : null;
    const isBlock = td.classList.contains('cal-block');
    const reservationId = isBlock ? td.getAttribute('data-reservation-id') : null;
    const isBooked = isBlock && td.classList.contains('status-booked');
    const isCheckedIn = isBlock && td.classList.contains('status-checked_in');

    function doCheckIn() {
      if (!reservationId) return;
      postWithCsrf(`/reservations/${reservationId}/check-in/`).then(ok => {
        if (!ok) { alert('Check-in failed. Please retry.'); return; }
        // Update UI: booked -> checked_in
        td.classList.remove('status-booked');
        td.classList.add('status-checked_in');
        td.title = (td.title || '').replace(/Booked/i, 'Checked-in');
      });
    }

    function doCheckOut() {
      if (!reservationId) return;
      postWithCsrf(`/reservations/${reservationId}/check-out/`).then(ok => {
        if (!ok) { alert('Check-out failed. Please retry.'); return; }
        // Replace block with a cleaning cell keeping the same colspan
        const span = td.getAttribute('colspan') || '1';
        const cleaning = document.createElement('td');
        cleaning.className = 'cal-cell cal-cleaning';
        cleaning.setAttribute('colspan', span);
        cleaning.setAttribute('data-room-id', tr.getAttribute('data-room-id') || '');
        cleaning.innerHTML = '<div class="text-muted"><i class="bi bi-broom icon me-1"></i> Cleaning</div>';
        td.replaceWith(cleaning);
        // Update badge to Cleaning
        const badge = tr.querySelector('th .badge');
        if (badge) {
          badge.textContent = 'Cleaning';
          badge.classList.remove('bg-secondary');
          badge.classList.add('bg-warning');
        }
      });
    }

    function doMarkClean() {
      if (!roomId) return;
      postWithCsrf(`/rooms/${roomId}/cleaned/`).then(ok => {
        if (!ok) { alert('Mark cleaned failed. Please retry.'); return; }
        // Update UI: change badge text to Available
        const badge = tr.querySelector('th .badge');
        if (badge) {
          badge.textContent = 'Available';
          badge.classList.remove('bg-warning');
          badge.classList.add('bg-secondary');
          // optional subtle flash
          badge.classList.add('bg-success');
          setTimeout(() => badge.classList.remove('bg-success'), 1000);
        }
        // Turn any cleaning cells in this row into empty cells
        const cells = Array.from(tr.querySelectorAll('td.cal-cleaning'));
        cells.forEach(c => {
          const span = c.getAttribute('colspan') || '1';
          const empty = document.createElement('td');
          empty.className = 'cal-cell cal-empty';
          empty.setAttribute('colspan', span);
          empty.setAttribute('data-room-id', tr.getAttribute('data-room-id') || '');
          c.replaceWith(empty);
          if (window._attachEmptyCellListeners) {
            window._attachEmptyCellListeners(empty);
          }
        });
      });
    }

    const items = [];
    if (reservationId && isBooked) {
      items.push({ label: 'Check-in', onClick: doCheckIn });
    }
    if (reservationId && isCheckedIn) {
      items.push({ label: 'Check-out', onClick: doCheckOut });
    }
    if (roomId) {
      items.push({ label: 'Mark room cleaned', onClick: doMarkClean });
    }

    hideMenu();
    showMenu(e.clientX, e.clientY, items);
  });

  document.addEventListener('click', (e) => {
    if (menu.style.display === 'block' && !menu.contains(e.target)) hideMenu();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hideMenu();
  });
})();
</script>

<script>
/* Compute daily statuses (arrivals, departures, dirty), update counters, and enable filters */
(function() {
  const headerCells = Array.from(document.querySelectorAll('.calendar-grid thead th[data-date]'));
  const headerDates = headerCells.map(th => th.dataset.date);
  const todayStr = new Date().toISOString().slice(0, 10);
  const todayIdx = headerDates.indexOf(todayStr);

  // Mark thead + body cells for "today"
  if (todayIdx >= 0) {
    headerCells[todayIdx]?.classList.add('is-today');
    document.querySelectorAll('.calendar-grid tbody tr').forEach(tr => {
      let acc = 0;
      for (const td of Array.from(tr.children).slice(1)) { // skip room header
        const span = parseInt(td.getAttribute('colspan') || '1', 10);
        const start = acc;
        const end = acc + span - 1;
        if (todayIdx >= start && todayIdx <= end) {
          td.classList.add('is-today-col');
          break;
        }
        acc += span;
      }
    });
  }

  // Mark weekends in header and body
  const weekendIdx = [];
  headerDates.forEach((ds, idx) => {
    const d = new Date(ds + 'T00:00:00');
    const wd = d.getDay(); // 0 Sun, 6 Sat
    if (wd === 0 || wd === 6) {
      weekendIdx.push(idx);
      headerCells[idx]?.classList.add('is-weekend');
    }
  });
  if (weekendIdx.length) {
    document.querySelectorAll('.calendar-grid tbody tr').forEach(tr => {
      let acc = 0;
      for (const td of Array.from(tr.children).slice(1)) {
        const span = parseInt(td.getAttribute('colspan') || '1', 10);
        const start = acc;
        const end = acc + span - 1;
        // Add weekend class if this cell covers any weekend index
        if (weekendIdx.some(i => i >= start && i <= end)) {
          td.classList.add('is-weekend-col');
        }
        acc += span;
      }
    });
  }

  function startIndex(td) {
    let acc = 0;
    for (const sib of Array.from(td.parentElement.children).slice(1)) {
      const span = parseInt(sib.getAttribute('colspan') || '1', 10);
      if (sib === td) return acc;
      acc += span;
    }
    return -1;
  }

  let arrivals = 0, departures = 0, dirty = 0;
  const rows = Array.from(document.querySelectorAll('.calendar-grid tbody tr[data-room-id]'));

  rows.forEach(tr => {
    const hasDirty = tr.querySelector('td.cal-cleaning') !== null;
    if (hasDirty) { tr.classList.add('row-dirty'); dirty++; }

    let hasArrival = false, hasDeparture = false;

    if (todayIdx >= 0) {
      tr.querySelectorAll('td.cal-block').forEach(td => {
        const start = startIndex(td);
        const span = parseInt(td.getAttribute('colspan') || '1', 10);
        const end = start + span - 1;
        if (td.classList.contains('status-booked') && start === todayIdx) hasArrival = true;
        if (td.classList.contains('status-checked_in') && end === todayIdx) hasDeparture = true;
      });
    }

    if (hasArrival) { tr.classList.add('row-arrival'); arrivals++; }
    if (hasDeparture) { tr.classList.add('row-departure'); departures++; }
  });

  // Update counters
  const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = String(val); };
  setText('arrivalsCount', arrivals);
  setText('departuresCount', departures);
  setText('dirtyCount', dirty);

  // Filters
  document.querySelectorAll('.cal-filter').forEach(btn => {
    btn.addEventListener('click', () => {
      const f = btn.dataset.filter;
      document.querySelectorAll('.cal-filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      rows.forEach(tr => {
        tr.style.display = '';
        if (f === 'arrival' && !tr.classList.contains('row-arrival')) tr.style.display = 'none';
        if (f === 'departure' && !tr.classList.contains('row-departure')) tr.style.display = 'none';
        if (f === 'dirty' && !tr.classList.contains('row-dirty')) tr.style.display = 'none';
      });
    });
  });
})();
</script>
{% endblock %}
