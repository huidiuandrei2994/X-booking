{% extends "hotellapp/base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary" href="?start={{ prev_start|date:'Y-m-d' }}&days={{ days }}"><i class="bi bi-arrow-left"></i> Prev</a>
    <a class="btn btn-outline-secondary" href="?start={{ next_start|date:'Y-m-d' }}&days={{ days }}">Next <i class="bi bi-arrow-right"></i></a>
    <div class="btn-group ms-2" role="group" aria-label="Range">
      <a class="btn btn-outline-primary {% if days == 7 %}active{% endif %}" href="?start={{ start|date:'Y-m-d' }}&days=7">7 days</a>
      <a class="btn btn-outline-primary {% if days == 14 %}active{% endif %}" href="?start={{ start|date:'Y-m-d' }}&days=14">14 days</a>
      <a class="btn btn-outline-primary {% if days == 30 %}active{% endif %}" href="?start={{ start|date:'Y-m-d' }}&days=30">30 days</a>
    </div>
  </div>
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-primary" href="{% url 'reservation_add' %}"><i class="bi bi-plus-circle"></i> New Reservation</a>
    <a class="btn btn-primary" href="{% url 'client_add' %}"><i class="bi bi-person-plus"></i> New Client</a>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div>
      <strong>Calendar</strong> • Starting {{ start|date:"Y-m-d" }}
    </div>
    <div class="text-muted">
      Occupancy today: {{ occupancy.0.percent }}% ({{ occupancy.0.count }}/{{ rooms_count }})
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 calendar-grid align-middle">
        <thead class="table-light">
          <tr>
            <th style="min-width: 160px;">Room</th>
            {% for d in dates %}
              <th class="text-center" data-date="{{ d.d|date:'Y-m-d' }}">
                <div class="small text-muted">{{ d.dow }}</div>
                <div>{{ d.d|date:"M d" }}</div>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in rooms_data %}
            <tr data-room-id="{{ row.room.id }}">
              <th>
                <div class="d-flex justify-content-between">
                  <span>#{{ row.room.number }} ({{ row.room.get_type_display }})</span>
                  <span class="badge bg-secondary">{{ row.room.get_status_display }}</span>
                </div>
              </th>
              {% for cell in row.cells %}
                {% if cell.type == 'empty' %}
                  {% for i in ""|center:cell.span %}
                    <td class="cal-cell cal-empty" data-room-id="{{ row.room.id }}"></td>
                  {% endfor %}
                {% else %}
                  <td class="cal-cell cal-block status-{{ cell.status }}" colspan="{{ cell.span }}"
                      data-reservation-id="{{ cell.reservation_id }}"
                      title="Reservation: {{ cell.label }} ({{ cell.status }})">
                    <div class="text-truncate">
                      <i class="bi bi-person-fill me-1"></i>{{ cell.label }}
                    </div>
                  </td>
                {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="p-2 small text-muted">
      Tip: Click a room’s empty start date, then click the end date to create a reservation prefilled with that range. Dragging across cells also works.
    </div>
  </div>
</div>

<style>
  .calendar-grid th, .calendar-grid td { white-space: nowrap; }
  .calendar-grid .cal-cell { min-width: 110px; height: 48px; position: relative; }
  .calendar-grid .cal-empty { cursor: crosshair; background: #fafafa; }
  .calendar-grid .cal-empty.highlight { background: #e7f1ff; }
  .calendar-grid .cal-block { background: #eef6ff; border-left: 3px solid #0d6efd; }
  .status-booked { background: #fff3cd !important; border-left-color: #ffca2c !important; }
  .status-checked_in { background: #d1e7dd !important; border-left-color: #198754 !important; }
</style>

<script>
(function() {
  // Build an array of dates for quick lookup from header
  const headerCells = Array.from(document.querySelectorAll('thead th[data-date]'));
  const headerDates = headerCells.map(th => th.dataset.date);

  // Selection state for creating reservation
  let selecting = false;
  let startCell = null;

  function cellDateIndex(td) {
    // Compute this td's starting day index within its row, accounting for colspans
    let acc = 0;
    for (const sib of Array.from(td.parentElement.children).slice(1)) { // skip first header (room)
      const span = parseInt(sib.getAttribute('colspan') || '1', 10);
      if (sib === td) return acc;
      acc += span;
    }
    return -1;
  }

  function getDateByIndex(i) {
    if (i < 0 || i >= headerDates.length) return null;
    return headerDates[i];
  }

  function clearHighlights(row) {
    row.querySelectorAll('.cal-empty.highlight').forEach(el => el.classList.remove('highlight'));
  }

  function highlightRange(row, startIdx, endIdx) {
    if (startIdx == null || endIdx == null) return;
    if (endIdx < startIdx) [startIdx, endIdx] = [endIdx, startIdx];
    let cursor = 0;
    for (const td of Array.from(row.children).slice(1)) {
      const span = parseInt(td.getAttribute('colspan') || '1', 10);
      const cellStart = cursor;
      const cellEnd = cursor + span - 1;
      if (td.classList.contains('cal-empty') && cellEnd >= startIdx && cellStart <= endIdx) {
        td.classList.add('highlight');
      }
      cursor += span;
    }
  }

  function beginSelection(td) {
    const row = td.parentElement;
    selecting = true;
    startCell = td;
    clearHighlights(row);
    const sIdx = cellDateIndex(td);
    highlightRange(row, sIdx, sIdx);
  }

  function endSelection(td) {
    const row = td.parentElement;
    const roomId = row.getAttribute('data-room-id');
    const startIdx = cellDateIndex(startCell);
    const endIdx = cellDateIndex(td);
    const [a, b] = startIdx <= endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
    const checkIn = getDateByIndex(a);
    const checkOutIdx = b + 1; // end date is exclusive
    const checkOut = getDateByIndex(checkOutIdx);
    if (!checkIn || !checkOut) {
      selecting = false; startCell = null; clearHighlights(row);
      return;
    }
    // Redirect to reservation add with prefilled data
    const url = new URL("{% url 'reservation_add' %}", window.location.origin);
    url.searchParams.set('room', roomId);
    url.searchParams.set('check_in', checkIn);
    url.searchParams.set('check_out', checkOut);
    window.location.href = url.toString();
  }

  // Attach events
  document.querySelectorAll('tbody td.cal-empty').forEach(td => {
    td.addEventListener('mousedown', (e) => { e.preventDefault(); beginSelection(td); });
    td.addEventListener('mouseenter', () => {
      if (!selecting || !startCell) return;
      const row = td.parentElement;
      clearHighlights(row);
      highlightRange(row, cellDateIndex(startCell), cellDateIndex(td));
    });
    td.addEventListener('mouseup', () => {
      if (!selecting || !startCell) return;
      endSelection(td);
      selecting = false;
      startCell = null;
    });
  });
  document.addEventListener('mouseup', () => {
    selecting = false; startCell = null;
    document.querySelectorAll('tbody tr').forEach(clearHighlights);
  });
})();
</script>
{% endblock %}
